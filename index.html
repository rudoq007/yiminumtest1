<!DOCTYPE html>
<html>
<head>
  <title>Yiminumâ€“Wilbowe Road (3D Terrain)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js">  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'top-right');
</script>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #video { height: 45vh; width: 100%; border-bottom: 2px solid #ccc; }
    #map { height: 55vh; width: 100%; }
    #infoBox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.85);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1;
    }
  #layerControl {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 2;
  background: white;
  padding: 6px;
  border-radius: 4px;
  box-shadow: 0 0 4px rgba(0,0,0,0.2);
  font-size: 13px;
}
</style>
</head>
<body>

<div id="video">
  <iframe id="ytplayer"
    src="https://www.youtube.com/embed/I45Jv-qWLEY?enablejsapi=1&rel=0"
    frameborder="0"
    allowfullscreen
    style="width:100%; height:100%;">
  </iframe>
</div>

<div id="layerControl">
  <label><input type="radio" name="basemap" value="hybrid" checked> Hybrid</label><br>
  <label><input type="radio" name="basemap" value="streets"> Streets</label><br>
  $1<br>
  <label><input type="radio" name="basemap" value="osm"> OSM</label>
</div>
<div id="map"></div>
<div id="infoBox">Distance Travelled: <span id="dist">0.00</span> km</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  let map, player, geoData = [], marker, trailLine;
  let started = false;

  let styleUrls = {
  osm: 'https://demotiles.maplibre.org/style.json',
  hybrid: 'https://api.maptiler.com/maps/hybrid/style.json?key=HuOH81AfcUjWmWVWJ8Yn',
  streets: 'https://api.maptiler.com/maps/streets/style.json?key=HuOH81AfcUjWmWVWJ8Yn',
  satellite: 'https://api.maptiler.com/maps/satellite/style.json?key=HuOH81AfcUjWmWVWJ8Yn'
};

map = new maplibregl.Map({
  container: 'map',
  style: styleUrls.hybrid,
    center: [142.503768133, -3.679434133],
    zoom: 13,
    pitch: 60,
    bearing: 90,
    antialias: true
  });

  document.querySelectorAll('input[name="basemap"]').forEach(radio => {
  radio.addEventListener('change', e => {
    const selectedStyle = e.target.value;
    map.setStyle(styleUrls[selectedStyle]);
    map.once('style.load', () => {
      map.setTerrain({ source: 'terrain', exaggeration: 1.2 });
      map.addLayer({
        id: 'sky',
        type: 'sky',
        paint: {
          'sky-type': 'atmosphere',
          'sky-atmosphere-sun': [0.0, 0.0],
          'sky-atmosphere-sun-intensity': 15
        }
      });
      map.addSource('trail', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });
      map.addLayer({
        id: 'trail-line',
        type: 'line',
        source: 'trail',
        paint: {
          'line-color': '#ff0000',
          'line-width': 4
        }
      });
    });
  });
});

map.on('load', () => {
    // Add terrain
    map.addSource('terrain', {
      type: 'raster-dem',
      url: 'https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=HuOH81AfcUjWmWVWJ8Yn',
      tileSize: 256,
      maxzoom: 14
    });

    map.setTerrain({ source: 'terrain', exaggeration: 1.2 });

    map.addLayer({
      id: 'sky',
      type: 'sky',
      paint: {
        'sky-type': 'atmosphere',
        'sky-atmosphere-sun': [0.0, 0.0],
        'sky-atmosphere-sun-intensity': 15
      }
    });

    // Add trail line
    map.addSource('trail', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
    });

    map.addLayer({
      id: 'trail-line',
      type: 'line',
      source: 'trail',
      paint: {
        'line-color': '#ff0000',
        'line-width': 4
      }
    });

    // Load GeoJSON route
    fetch('yiminum_wilbowe_timestamped.geojson')
      .then(res => res.json())
      .then(data => {
        geoData = data.features;
        initMarker();
        setInterval(syncWithVideo, 1000);
      });
  });

  function initMarker() {
    let el = document.createElement('div');
    el.style.width = '30px';
    el.style.height = '30px';
    el.style.backgroundImage = "url('https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg')";
    el.style.backgroundSize = 'contain';
    el.style.backgroundRepeat = 'no-repeat';
    el.style.transform = 'none';

    marker = new maplibregl.Marker(el)
      .setLngLat([142.503768133, -3.679434133])
      .addTo(map);
  }

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer');
  }

  function syncWithVideo() {
    if (!player || geoData.length === 0 || typeof player.getCurrentTime !== 'function') return;

    const time = player.getCurrentTime();
    const points = geoData.filter(f => f.properties.timestamp_sec !== undefined);
    if (points.length === 0) return;

    let closest = points.reduce((prev, curr) => {
      return Math.abs(curr.properties.timestamp_sec - time) < Math.abs(prev.properties.timestamp_sec - time)
        ? curr : prev;
    });

    let index = points.indexOf(closest);
    if (index < 0) return;

    let [lon, lat] = closest.geometry.coordinates;
    marker.setLngLat([lon, lat]);

    // Rotate vehicle
    if (index < points.length - 1) {
      let [lon1, lat1] = closest.geometry.coordinates;
      let [lon2, lat2] = points[index + 1].geometry.coordinates;
      let angle = Math.atan2(lat2 - lat1, lon2 - lon1) * 180 / Math.PI;
      // No rotation needed for red dot marker
    }

    // Add to trail
    let trailCoords = points.slice(0, index + 1).map(f => f.geometry.coordinates);
    map.getSource('trail').setData({
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: trailCoords
      }
    });

    // Smooth follow camera
    map.easeTo({
      center: [lon, lat],
      zoom: 15,
      bearing: 90,
      pitch: 60,
      duration: 1000,
      easing: t => t
    });

    // Update distance
    let dist = closest.properties.cum_distance_km;
    document.getElementById('dist').innerText = dist.toFixed(2);
  }
</script>
</body>
</html>
