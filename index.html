<!DOCTYPE html>
<html>
<head>
  <title>Yiminumâ€“Wilbowe 3D Map (Mapbox GL JS)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 40%; bottom: 0; width: 100%; }
    #video { width: 100%; height: 40%; border-bottom: 2px solid #ccc; }
    #distBox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.85);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1;
    }
  </style>
</head>
<body>

<div id="video">
  <iframe id="ytplayer"
    src="https://www.youtube.com/embed/I45Jv-qWLEY?enablejsapi=1&rel=0"
    frameborder="0"
    allowfullscreen
    style="width:100%; height:100%;">
  </iframe>
</div>

<div id="map"></div>
<div id="distBox">Distance Travelled: <span id="dist">0.00</span> km</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoicnB1a2EtMjAyMyIsImEiOiJjbGZ1Z2JidnAwMW84M3NudWwxMnliZDEzIn0.cVQ5fg8pJidSLrGq4I4vGQ';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/satellite-v9',
    center: [142.503768133, -3.679434133], // default starting point
    zoom: 15,
    pitch: 60,
    bearing: 90,
    antialias: true
  });

  // Placeholder marker
  let marker = new mapboxgl.Marker({ color: 'red' })
    .setLngLat([142.503768133, -3.679434133])
    .addTo(map);

  let geoData, player;

  fetch('yiminum_wilbowe_timestamped.geojson')
    .then(res => res.json())
    .then(data => {
      geoData = data.features;
      setInterval(syncWithVideo, 1000);
    });

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer');
  }

  function syncWithVideo() {
    if (!player || !geoData || geoData.length === 0) return;
    let time = player.getCurrentTime();
    let closest = geoData.reduce((prev, curr) => {
      return Math.abs(curr.properties.timestamp_sec - time) < Math.abs(prev.properties.timestamp_sec - time)
        ? curr : prev;
    });

    let [lon, lat] = closest.geometry.coordinates;
    let dist = closest.properties.cum_distance_km || 0;

    marker.setLngLat([lon, lat]);

    map.flyTo({
      center: [lon, lat],
      zoom: 17,
      pitch: 60,
      bearing: 90,
      speed: 0.8,
      curve: 1.2
    });

    document.getElementById('dist').innerText = dist.toFixed(2);
  }
</script>

<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
